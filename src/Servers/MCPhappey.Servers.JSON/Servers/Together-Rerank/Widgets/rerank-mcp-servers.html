<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>MCP Rerank Server Results</title>
  <script>window.deferLoadingAlpine = (start) => window._startAlpine = start;</script>
  <script src="%HOST_URL%/widget-base.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.0/dist/cdn.min.js" defer></script>
  <script src="%HOST_URL%/chatapp-header.js" defer></script>
  <script src="%HOST_URL%/chatapp-carousel.js" defer></script>
  <script src="%HOST_URL%/chatapp-card.js" defer></script>
  <link rel="stylesheet" href="%HOST_URL%/widget.css" />

  <script>
    window.mcpRerankServersWidget = function () {
      return {
        data: window.openai?.toolOutput || null,
        input: window.openai?.toolInput || null,
        results: [],
        count: 0,

        init() {
          widgetBase.syncOpenAI(this);
          const ui = Alpine.store('ui');
          if (ui?.maxHeight) document.body.style.height = ui.maxHeight + 'px';
          this.load();
        },

        parseServerText(docText) {
          try {
            const parsed = JSON.parse(docText);
            return Array.isArray(parsed.servers)
              ? parsed.servers.map(s => s.server)
              : [];
          } catch {
            return [];
          }
        },

        load() {
          const arr = this.data?.results ?? [];
          const servers = [];

          arr.forEach((r, i) => {
            const parsedServers = this.parseServerText(r.document?.text);
            parsedServers.forEach((srv, j) => {
              servers.push({
                id: `${i}-${j}-${srv.name}`,
                name: srv.name || "Unnamed server",
                description: srv.description || "—",
                version: srv.version || "—",
                repo: srv.repository?.url || null,
                remoteUrl: srv.remotes?.[0]?.url || null,
                relevance: r.relevance_score?.toFixed(3) ?? "—"
              });
            });
          });

          this.results = servers;
          this.count = servers.length;
        },

        getHeader() {
          return `MCP Servers Rerank: ${this.input?.query ?? ''} (${this.count})`;
        }
      };
    };
  </script>

  <style>
    .snippet {
      display: -webkit-box;
      -webkit-line-clamp: 5;
      line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      font-size: small;
      line-height: 1.4;
    }

    .relevance {
      font-weight: 500;
      color: var(--muted-color, #666);
      font-size: 0.85em;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <div x-data="mcpRerankServersWidget()" x-init="init()"
    style="display:flex; flex-direction:column; height:100%; overflow:hidden;">
    <chatapp-header :text="getHeader()" no-fullscreen></chatapp-header>

    <chatapp-carousel style="flex:1; min-height:0;">
      <template x-for="r in results" :key="r.id">
        <chatapp-card :title="r.name" :description="'Relevance: ' + r.relevance + ' | v' + r.version">
          <div slot="content">
            <div class="snippet" x-text="r.description"></div>
          </div>

          <template x-if="r.remoteUrl">
            <button slot="actions" @click.prevent="window.open(r.remoteUrl, '_blank')">Open Server</button>
          </template>

          <template x-if="r.repo">
            <button slot="actions" @click.prevent="window.open(r.repo, '_blank')">GitHub</button>
          </template>

          <button slot="actions"
            @click.prevent="window.askFollowup('Explain why this server (' + r.name + ') is relevant for the query: ' + (input?.query || ''))">
            Explain relevance
          </button>
        </chatapp-card>
      </template>
    </chatapp-carousel>
  </div>

  <script>window._startAlpine && window._startAlpine();</script>
</body>

</html>