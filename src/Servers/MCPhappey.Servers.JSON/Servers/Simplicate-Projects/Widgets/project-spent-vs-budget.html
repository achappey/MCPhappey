<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Budgetverbruik per categorie</title>
    <script>window.deferLoadingAlpine = (s) => window._startAlpine = s;</script>
    <script src="%HOST_URL%/widget-base.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.0/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.js"></script>
    <script src="%HOST_URL%/chatapp-header.js" defer></script>
    <script src="%HOST_URL%/chatapp-chart.js" defer></script>
    <link rel="stylesheet" href="%HOST_URL%/widget.css" />
    <style>
        html {
            overflow: hidden;
        }

        body {
            margin: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .body {
            flex: 1;
            padding: 6px;
            display: flex;
            height: 100%;
            min-height: 0;
        }

        chart-js {
            width: 100%;
        }
    </style>

    <script>
        window.projectBudgetDistributionWidget = function () {
            return {
                data: window.openai?.toolOutput || null,
                init() { widgetBase.syncOpenAI(this); this.$nextTick(() => this.load()) },
                load() {
                    this.$nextTick(() => {
                        const projects = Array.isArray(this.data?.projects) ? this.data.projects : [];
                        const el = this.$refs.chart; if (!el || !projects.length) return;

                        // ðŸ§® classify into bands
                        const bands = {
                            "<80%": p => p.spent_ratio < 80,
                            "80â€“100%": p => p.spent_ratio >= 80 && p.spent_ratio <= 100,
                            "100â€“150%": p => p.spent_ratio > 100 && p.spent_ratio <= 150,
                            ">150%": p => p.spent_ratio > 150
                        };
                        const counts = Object.entries(bands).map(([label, fn]) => ({
                            label, count: projects.filter(fn).length
                        }));

                        const data = {
                            labels: counts.map(c => c.label),
                            datasets: [{
                                label: "Aantal projecten",
                                data: counts.map(c => c.count),
                                backgroundColor: [
                                    "rgba(90,181,72,0.8)",
                                    "rgba(242,142,43,0.8)",
                                    "rgba(224,102,102,0.8)",
                                    "rgba(199,43,83,0.8)"
                                ],
                                borderRadius: 3
                            }]
                        };

                        const options = {
                            responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                            scales: {
                                x: { title: { display: true, text: "Categorie verbruik" } },
                                y: { beginAtZero: true, title: { display: true, text: "Aantal projecten" } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.raw} projecten`
                                    }
                                }
                            }
                        };

                        el.update({ type: "bar", data, options, height: 250 });
                    });
                }
            }
        }
    </script>
</head>

<body>
    <div x-data="projectBudgetDistributionWidget()" x-init="init()"
        style="display:flex;flex-direction:column;height:100%;">
        <chatapp-header text="Budgetverbruik per categorie" no-fullscreen></chatapp-header>
        <div class="body"><chatapp-chart x-ref="chart"></chatapp-chart></div>
    </div>
    <script>window._startAlpine && window._startAlpine();</script>
</body>

</html>