<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Invoice Totals per Organization</title>
  <script>window.deferLoadingAlpine = (start) => window._startAlpine = start;</script>
  <script src="%HOST_URL%/widget-base.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.js"></script>
  <script src="%HOST_URL%/chatapp-header.js" defer></script>
  <script src="%HOST_URL%/chatapp-chart.js" defer></script>
  <link rel="stylesheet" href="%HOST_URL%/widget.css" />
  <style>
    html { overflow: hidden; }
    body { margin: 0; height: 100%; display: flex; flex-direction: column; }
    .body { flex: 1; padding: 8px; display: flex; height: 100% }
    chart-js { width: 100%; }
  </style>

  <script>
    window.invoiceTotalsWidget = function () {
      return {
        data: window.openai?.toolOutput || null,
        init() {
          widgetBase.syncOpenAI(this);
          const ui = Alpine.store('ui');
          if (ui?.maxHeight) document.body.style.height = ui.maxHeight + 'px';
          this.$nextTick(() => this.load());
        },
        load() {
          this.$nextTick(() => {
            const profiles = Array.isArray(this.data?.my_organization_profiles)
              ? this.data.my_organization_profiles
              : [];
            const el = this.$refs.chart;
            if (!el || !profiles.length) return;

            // ðŸ“† collect all unique months across orgs
            const allMonths = [
              ...new Set(
                profiles.flatMap(p => (p.invoices || []).map(i => i.month))
              )
            ].sort();

            // ðŸŽ¨ color palette (extendable)
            const colors = [
              "#4e79a7", "#f28e2b", "#e15759", "#76b7b2", "#59a14f",
              "#edc948", "#b07aa1", "#ff9da7", "#9c755f", "#bab0ac"
            ];

            // ðŸ§® build datasets
            const datasets = profiles.map((p, idx) => {
              const dict = Object.fromEntries(
                (p.invoices || []).map(i => [i.month, i.totalExcludingVat || 0])
              );
              const values = allMonths.map(m => Number(dict[m] || 0));
              return {
                label: p.name || "(Onbekend)",
                data: values,
                borderColor: colors[idx % colors.length],
                backgroundColor: colors[idx % colors.length],
                fill: false,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 2
              };
            });

            const data = { labels: allMonths, datasets };

            const options = {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },
              animation: { duration: 0 },
              scales: {
                x: {
                  title: { display: true, text: "Maand" },
                  ticks: { callback: v => allMonths[v]?.slice(2) ?? "" } // show YY-MM
                },
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Totaal excl. BTW (â‚¬)" },
                  ticks: {
                    callback: val => "â‚¬" + Number(val).toLocaleString("nl-NL")
                  }
                }
              },
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { boxWidth: 12, font: { size: 10 } }
                },
                tooltip: {
                  callbacks: {
                    label: (ctx) =>
                      `${ctx.dataset.label}: â‚¬${Number(ctx.raw)
                        .toLocaleString("nl-NL", { maximumFractionDigits: 0 })}`
                  }
                }
              }
            };

            el.update({ type: "line", data, options, height: 250 });
          });
        }
      }
    }
  </script>
</head>

<body>
  <div x-data="invoiceTotalsWidget()" x-init="init()" style="display:flex; flex-direction:column; height:100%;">
    <chatapp-header text="Factuurtotalen per organisatie (excl. BTW)" no-fullscreen></chatapp-header>
    <div class="body">
      <chatapp-chart x-ref="chart"></chatapp-chart>
    </div>
  </div>
  <script>window._startAlpine && window._startAlpine();</script>
</body>

</html>
